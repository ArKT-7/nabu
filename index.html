<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash .img files by ArKt</title>
    <script src="dist/fastboot.mjs" type="module"></script>
    <script src="download.js" type="module"></script>
</head>
<body>
    <div>
        <p>Status: <span class="status-field" aria-live="polite">Not connected in Fastboot</span></p>
        <button class="connect-button">Connect device Fastboot</button>
    </div>
    
    <hr />

    <div>
        <form class="command-form">
            <label for="command">Command without fastboot lol:</label>
            <input type="text" name="command" class="command-input" />
            <input type="submit" value="Send" />
        </form>
        <button class="reboot-button">Reboot Device</button> <!-- Reboot button -->
        <button class="reboot-bootloader-button">Reboot to Bootloader</button> <!-- New reboot to bootloader button -->
        <button class="reboot-recovery-button">Reboot to Recovery</button> <!-- New reboot to recovery button -->
        <button class="reboot-fastbootd-button">Reboot to FastbootD</button> <!-- New reboot to FastbootD button -->
        <p>Result:</p>
        <pre class="result-field"></pre>
    </div>

    <hr />

    <div>
        <form class="boot-form">
            <label for="boot-file">Boot image:</label>
            <input type="file" name="boot-file" class="boot-file" />
            <input type="submit" value="Boot" />
        </form>
    </div>

    <hr />

    <div>
        <form class="flash-form">
            <label for="flash-file">Flash image:</label>
            <input type="file" name="flash-file" class="flash-file" onchange="updateFlashButtons()" />
            <br />
            <label for="flash-partition">Partition:</label>
            <input type="text" name="flash-partition" class="flash-partition" />
            <input type="submit" value="Flash" />
        </form>
        <button class="flash-boot-button" disabled>Flash Boot</button>
        <button class="flash-boot_a-button" disabled>Flash Boot_A</button>
        <button class="flash-boot_b-button" disabled>Flash Boot_B</button>
        <p class="flash-status-field" aria-live="polite"></p> <!-- Status for flash operations -->
    </div>

    <hr />

    <div>
        <p>Status: <span class="factory-status-field"></span></p>
        <progress class="factory-progress-bar" max="1" value="0"></progress>
        <button class="reconnect-button" style="display: none;"><h3>Reconnect device</h3></button>
        <br />
        <form class="factory-form">
            <label for="factory-file">Flash custom factory images zip:</label>
            <br />
            <input type="file" name="factory-file" class="factory-file" />
            <br />
            <input type="submit" value="Flash selected zip" />
        </form>
        <br />
    </div>

    <script type="module">
        // Importing necessary modules
        import * as fastboot from "./dist/fastboot.mjs";
        import { BlobStore } from "./download.js";

        let device = new fastboot.FastbootDevice();
        window.device = device;
        let blobStore = new BlobStore();

        // Enable verbose debug logging
        fastboot.setDebugLevel(2);

        async function connectDevice() {
            let statusField = document.querySelector(".status-field");
            statusField.textContent = "Connecting...";

            try {
                await device.connect();
            } catch (error) {
                statusField.textContent = `Failed to connect to device: ${error.message}`;
                return;
            }

            let product = await device.getVariable("product");
            let serial = await device.getVariable("serialno");
            let status = `Connected to ${product} (serial: ${serial})`;
            statusField.textContent = status;
        }

        async function sendFormCommand(event) {
            event.preventDefault();

            let inputField = document.querySelector(".command-input");
            let command = inputField.value;
            let result = (await device.runCommand(command)).text;
            document.querySelector(".result-field").textContent = result;
            inputField.value = "";
        }

        async function rebootDevice() {
            let command = "reboot"; // Command to send
            let result = (await device.runCommand(command)).text;
            document.querySelector(".result-field").textContent = result; // Display result
        }

        async function rebootToBootloader() {
            let command = "reboot-bootloader"; // Command to send
            let result = (await device.runCommand(command)).text;
            document.querySelector(".result-field").textContent = result; // Display result
        }

        async function rebootToRecovery() {
            let command = "reboot-recovery"; // Command to send
            let result = (await device.runCommand(command)).text;
            document.querySelector(".result-field").textContent = result; // Display result
        }

        async function rebootToFastbootD() {
            let command = "reboot-fastboot"; // Command to send
            let result = (await device.runCommand(command)).text;
            document.querySelector(".result-field").textContent = result; // Display result
        }

        async function bootFormFile(event) {
            event.preventDefault();

            let fileField = document.querySelector(".boot-file");
            let file = fileField.files[0];
            await device.bootBlob(file);
            fileField.value = "";
        }

        async function flashFormFile(event) {
            event.preventDefault();

            let fileField = document.querySelector(".flash-file");
            let partField = document.querySelector(".flash-partition");
            let file = fileField.files[0];
            
            if (!file) {
                alert("Please select a file to flash.");
                return;
            }
            await device.flashBlob(partField.value, file);
            fileField.value = "";
            partField.value = "";
        }

        async function flashFactoryZip(blob) {
            let statusField = document.querySelector(".factory-status-field");
            statusField.textContent = "Flashing...";

            let progressBar = document.querySelector(".factory-progress-bar");

            try {
                await device.flashFactoryZip(
                    blob,
                    false,
                    reconnectCallback,
                    // Progress callback
                    (action, item, progress) => {
                        let userAction = fastboot.USER_ACTION_MAP[action];
                        statusField.textContent = `${userAction} ${item}`;
                        progressBar.value = progress;
                    }
                );
            } catch (error) {
                statusField.textContent = `Failed to flash zip: ${error.message}`;
                throw error;
            }

            statusField.textContent = "Successfully flashed factory images";
        }

        async function flashSelectedFactoryZip(event) {
            event.preventDefault();

            let fileField = document.querySelector(".factory-file");
            await flashFactoryZip(fileField.files[0]);
            fileField.value = "";
        }

        // Function to enable/disable flash buttons based on file selection
        function updateFlashButtons() {
            let fileField = document.querySelector(".flash-file");
            let flashBootButton = document.querySelector(".flash-boot-button");
            let flashBootAButton = document.querySelector(".flash-boot_a-button");
            let flashBootBButton = document.querySelector(".flash-boot_b-button");

            let isFileSelected = fileField.files.length > 0;

            flashBootButton.disabled = !isFileSelected;
            flashBootAButton.disabled = !isFileSelected;
            flashBootBButton.disabled = !isFileSelected;
        }

        // Function to flash the boot partition
        async function flashBoot() {
            let fileField = document.querySelector(".flash-file");
            let file = fileField.files[0];

            try {
                await device.flashBlob("boot", file);
                document.querySelector(".flash-status-field").textContent = "Successfully flashed boot partition.";
            } catch (error) {
                alert(`Failed to flash boot: ${error.message}`);
            }
        }

        // Function to flash the boot_a partition
        async function flashBootA() {
            let fileField = document.querySelector(".flash-file");
            let file = fileField.files[0];

            try {
                await device.flashBlob("boot_a", file);
                document.querySelector(".flash-status-field").textContent = "Successfully flashed boot_a partition.";
            } catch (error) {
                alert(`Failed to flash boot_a: ${error.message}`);
            }
        }

        // Function to flash the boot_b partition
        async function flashBootB() {
            let fileField = document.querySelector(".flash-file");
            let file = fileField.files[0];

            try {
                await device.flashBlob("boot_b", file);
                document.querySelector(".flash-status-field").textContent = "Successfully flashed boot_b partition.";
            } catch (error) {
                alert(`Failed to flash boot_b: ${error.message}`);
            }
        }

        // Adding event listeners for the new buttons
        document.querySelector(".flash-boot-button").addEventListener("click", flashBoot);
        document.querySelector(".flash-boot_a-button").addEventListener("click", flashBootA);
        document.querySelector(".flash-boot_b-button").addEventListener("click", flashBootB);
        document.querySelector(".connect-button").addEventListener("click", connectDevice);
        document.querySelector(".command-form").addEventListener("submit", sendFormCommand);
        document.querySelector(".reboot-button").addEventListener("click", rebootDevice);
        document.querySelector(".reboot-bootloader-button").addEventListener("click", rebootToBootloader);
        document.querySelector(".reboot-recovery-button").addEventListener("click", rebootToRecovery);
        document.querySelector(".reboot-fastbootd-button").addEventListener("click", rebootToFastbootD);
        document.querySelector(".boot-form").addEventListener("submit", bootFormFile);
        document.querySelector(".flash-form").addEventListener("submit", flashFormFile);
        document.querySelector(".factory-form").addEventListener("submit", flashSelectedFactoryZip);
    </script>
</body>
</html>
