<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="dist/fastboot.mjs" type="module"></script>
    <script src="download.js" type="module"></script>
    <meta property="og:title" content="Fastboot Tool by ArKT" />
    <meta property="og:description" content="It can boot Images like recovery and can flash images in any partition" />
    <meta property="og:url" content="https://arkt-7.github.io/nabu/" />
    <meta property="og:type" content="website" />
    <meta name="description" content="It can boot Images like recovery and can flash images in any partition" />
    <meta name="title" content="Fastboot Tool for flashing/booting/rooting" />
    <title>Fastboot Tool by ArKT</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/android.png" type="image/png">
    <style>
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f0f0;
    color: #333;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative; /* Added */
}

h1 {
    color: #4a4a4a;
}

.container {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 20px;
    width: 100%;
    max-width: 600px;
    margin: 10px;
}

.button {
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    color: white;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    margin: 5px 0;
    width: 100%;
}

.button:hover {
    background-color: #0056b3;
    transform: scale(1.02);
}

.button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

input[type="text"],
input[type="file"],
select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

label {
    font-weight: bold;
}

.progress-container {
    width: 100%;
    height: 20px;
    background-color: #f3f3f3;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
    display: none; /* Initially hidden */
}

.progress-bar {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: width 0.5s;
}

.status-field {
    font-weight: bold;
    margin-bottom: 10px;
}

pre.result-field {
    background-color: #f3f3f3;
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
    white-space: pre-wrap;
    max-height: 200px;
    border: 1px solid #ccc;
}

/* Styles for the progress overlay */
#progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: none; /* Hidden initially */
    justify-content: center;
    align-items: center;
    z-index: 1000; /* Bring it above everything */
}

#progress-overlay.active {
    display: flex;
}

#progress-message {
    color: white;
    font-size: 24px;
    text-align: center;
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}
    </style>
</head>
<body>
    <h1>Fastboot Tool by ArKT</h1>

<!-- Add a progress overlay for the "Processing... Please wait" message -->
<div id="progress-overlay">
    <div id="progress-message">Processing... Please wait</div>
</div>

<div class="container">
    <p class="status-field">Not connected in Fastboot</p>
    <button class="button connect-button">Connect device Fastboot</button>
</div>

<hr />

<div class="container">
    <form class="command-form">
        <label for="command">Fastboot Command:</label>
        <input type="text" name="command" class="command-input" placeholder="Enter fastboot command here without 'fastboot' " />
        <input type="submit" value="Send" class="button" />
    </form>
    <button class="button reboot-button">Reboot Device</button>
    <button class="button reboot-bootloader-button">Reboot to Bootloader</button>
    <button class="button reboot-recovery-button">Reboot to Recovery</button>
    <button class="button reboot-fastbootd-button">Reboot to FastbootD</button>
    <button class="button reboot-edl-button">Reboot to EDL</button>
</div>

<hr />

<div class="container">
    <form class="boot-form">
        <label for="boot-file">Boot image:</label>
        <input type="file" id="boot-file" name="boot-file" accept=".img" />
        <select name="boot-type" class="boot-type">
            <option value="">Select Images to boot on Nabu directly</option>
            <option value="twrp-nabu">Twrp Recovery Nabu</option>
            <option value="win-uefi-nabu">Windows UEFI Boot Nabu</option>
            <option value="twrp-mod-nabu">Twrp Modded Recovery Nabu</option>
            <option value="orangefox-mod-nabu">OrangeFox Modded Recovery Nabu</option>
        </select>
        <input type="submit" value="Boot" class="button" />
        <div class="progress-container" style="display: none;">
            <div class="progress-bar"></div>
        </div>
    </form>
</div>

<hr />

<div class="container">
    <form class="flash-form">
        <label for="flash-file">Flash image:</label>
        <input type="file" name="flash-file" class="flash-file" accept=".img" onchange="validateFile(this)" required />
        <br />
        <label for="flash-partition">Partition:</label>
        <input type="text" name="flash-partition" class="flash-partition" placeholder="Enter partition like- boot, dtbo, cust, recovery, etc." />
        <input type="submit" value="Flash" class="button" />
    </form>
    <button class="button flash-boot-button">Flash to Boot (current slot)</button>
    <button class="button flash-boot-ab-button">Flash to Boot ab (both slots)</button>
    <button class="button flash-boot-a-button">Flash to Boot A only</button>
    <button class="button flash-boot-b-button">Flash to Boot B only</button>
</div>

<hr />


    <!-- New Container for Downloading and Flashing Images
    <div class="container">
    <form class="flash-image-form">
        <label for="flash-boot-file">Download and Flash Boot Image:</label>
        <input type="file" name="flash-boot-file" class="flash-boot-file" />
        <select name="flash-boot-type" class="flash-boot-type">
            <option value="">Select Boot Images for Flashing</option>
            <option value="twrp-nabu">Twrp Recovery Nabu</option>
            <option value="win-uefi-nabu">Windows UEFI Boot Nabu</option>
            <option value="twrp-mod-nabu">Twrp Modded Recovery Nabu</option>
            <option value="orangefox-mod-nabu">OrangeFox Modded Recovery Nabu</option>
        </select>
        <button type="button" class="button flash-boot-button">Flash to Boot</button>
        <button type="button" class="button flash-boot-a-button">Flash to Boot A</button>
        <button type="button" class="button flash-boot-b-button">Flash to Boot B</button>
        <div class="progress-container" style="display: none;">
            <div class="progress-bar"></div>
        </div>
    </form>
</div>


    <hr />
 -->
   <script type="module">
    import * as fastboot from "./dist/fastboot.mjs";
    import { BlobStore } from "./download.js";

    let device = new fastboot.FastbootDevice();
    window.device = device;
    let blobStore = new BlobStore();

    fastboot.setDebugLevel(2);

    // Utility function to show the progress overlay and disable buttons
    function showProgressOverlay() {
        const progressOverlay = document.getElementById('progress-overlay');
        const buttons = document.querySelectorAll('.button');
        progressOverlay.classList.add('active');
        buttons.forEach(button => {
            button.disabled = true;
        });
    }

    // Utility function to hide the progress overlay and enable buttons
    function hideProgressOverlay() {
        const progressOverlay = document.getElementById('progress-overlay');
        const buttons = document.querySelectorAll('.button');
        progressOverlay.classList.remove('active');
        buttons.forEach(button => {
            button.disabled = false;
        });
    }

    // Validation function to allow only .img files
    function validateFile(inputElement) {
        const file = inputElement.files[0];
        const errorMessage = document.createElement('p');
        errorMessage.style.color = 'red';

        if (!file || !file.name.endsWith('.img')) {
            errorMessage.textContent = 'Please select a valid .img file.';
            inputElement.parentNode.appendChild(errorMessage);
            inputElement.value = ''; // Clear invalid file input
        } else {
            const existingError = inputElement.parentNode.querySelector('p');
            if (existingError) {
                existingError.remove(); // Remove error message if file is valid
            }
        }
    }

    function toggleElements(disable) {
        const formElements = document.querySelectorAll("input, button, select");
        formElements.forEach((element) => {
            if (!element.classList.contains('connect-button')) {
                element.disabled = disable;
            }
        });
    }

    async function connectDevice() {
        let statusField = document.querySelector(".status-field");
        statusField.textContent = "Connecting...";

        try {
            await device.connect();
        } catch (error) {
            statusField.textContent = `Failed to connect to device: ${error.message}`;
            hideProgressOverlay();
            return;
        }

        let product = await device.getVariable("product");
        let slot = await device.getVariable("current-slot");
        let serial = await device.getVariable("serialno");
        let bootloaderStatus = await device.getVariable("unlocked");

        let deviceName = "";
        if (product === "nabu") {
            deviceName = "Device name - Xiaomi Pad 5";
        } else if (product === "dm3q") {
            deviceName = "Device name - Samsung S23 Ultra";
        }

        let status = `Connected to - ${product} <br /> Current slot - ${slot} <br /> (serial: ${serial})`;
        if (deviceName) {
            status += `<br />${deviceName}`;
        }

        status += `<br />Bootloader status: ${bootloaderStatus ? 'Unlocked' : 'Locked'}`;
        statusField.innerHTML = status;

        toggleElements(false); // Enable all elements when connected
    }

    toggleElements(true); // Initially disable all features

    function handleDisconnect() {
        let statusField = document.querySelector(".status-field");
        statusField.textContent = "Not connected in Fastboot";
        toggleElements(true); // Disable all elements on disconnect
    }

    async function sendFormCommand(event) {
        event.preventDefault();
        showProgressOverlay();
        let inputField = document.querySelector(".command-input");
        let command = inputField.value;
        if (!command.trim()) {
            alert("Please enter a command!");
            hideProgressOverlay();
            return;
        }

        let result = (await device.runCommand(command)).text;
        document.querySelector(".result-field").textContent = result;
        inputField.value = "";
        hideProgressOverlay();
    }

    async function rebootDevice() {
        await runRebootCommand("reboot", "Device rebooted successfully!");
    }

    async function rebootToBootloader() {
        await runRebootCommand("reboot-bootloader", "Rebooted to Bootloader successfully!");
    }

    async function rebootToRecovery() {
        await runRebootCommand("reboot-recovery", "Rebooted to Recovery successfully!");
    }

    async function rebootToFastbootD() {
        await runRebootCommand("reboot-fastboot", "Rebooted to FastbootD successfully!");
    }

    async function rebootToEDL() {
        await runRebootCommand("oem edl", "Rebooted to EDL successfully!");
    }

    async function runRebootCommand(command, successMessage) {
        let result = (await device.runCommand(command)).text;
        document.querySelector(".result-field").textContent = result;
    }

    async function bootFormFile(event) {
        event.preventDefault();
        showProgressOverlay();
        let fileField = document.querySelector("#boot-file");
        let bootTypeSelect = document.querySelector(".boot-type");
        let selectedBootType = bootTypeSelect.value;

        let file;
        if (fileField.files.length > 0) {
            file = fileField.files[0];
        } else if (selectedBootType) {
            file = await downloadBootImage(getImagePath(selectedBootType));
        } else {
            alert("Please select a boot image file or choose a boot type!");
            hideProgressOverlay();
            return;
        }

        if (!file) {
            alert("Failed to obtain a valid boot image.");
            hideProgressOverlay();
            return;
        }

        try {
            await device.bootBlob(file);
            alert("Boot image booted successfully!");
        } catch (error) {
            console.error("Error booting image:", error);
            alert("Error booting image. Please try again.");
        } finally {
            fileField.value = ""; // Reset file input after use
            bootTypeSelect.selectedIndex = 0; // Reset selection
            hideProgressOverlay();
        }
    }

    function getImagePath(selectedBootType) {
        switch (selectedBootType) {
            case "twrp-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/twrp-nabu.img";
            case "win-uefi-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/uefi-nabu.img";
            case "twrp-mod-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/twrp-modded-nabu.img";
            case "orangefox-mod-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/orangefox-modded-nabu.img";
            default:
                return null;
        }
    }

    async function downloadBootImage(imagePath) {
        const progressBarContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        progressBarContainer.style.display = 'block'; // Show the progress bar

        try {
            const response = await fetch(imagePath);
            if (!response.ok) throw new Error("Failed to download boot image");

            const contentLength = response.headers.get('Content-Length');
            const total = parseInt(contentLength, 10);
            let loaded = 0;

            const reader = response.body.getReader();
            const chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                progressBar.style.width = `${(loaded / total) * 100}%`;
            }

            const blob = new Blob(chunks);
            return blob;
        } catch (error) {
            console.error("Download error:", error);
            alert("Error downloading boot image. Please try again.");
        } finally {
            progressBarContainer.style.display = 'none'; // Hide the progress bar
        }
    }

    async function flashFormFile(event) {
        event.preventDefault();
        showProgressOverlay();
        let fileField = document.querySelector(".flash-file");
        let partField = document.querySelector(".flash-partition");
        let file = fileField.files[0];

        if (!file) {
            alert("Please select a file to flash!");
            hideProgressOverlay();
            return;
        }

        if (!partField.value) {
            alert("Please specify a partition to flash!");
            hideProgressOverlay();
            return;
        }

        try {
            await device.flashBlob(partField.value, file);
            alert(`Successfully flashed ${partField.value}`);
        } catch (error) {
            alert(`Failed to flash: ${error.message}`);
        } finally {
            fileField.value = "";
            partField.value = "";
            hideProgressOverlay();
        }
    }

    async function handleFlash(partition) {
        showProgressOverlay();
        const fileField = document.querySelector(".flash-file");
        const file = fileField.files[0];

        if (!file) {
            alert("Please select a file to flash!");
            hideProgressOverlay();
            return;
        }

        try {
            await device.flashBlob(partition, file);
            alert(`Successfully flashed ${partition}`);
        } catch (error) {
            alert(`Failed to flash ${partition}: ${error.message}`);
        } finally {
            fileField.value = "";
            hideProgressOverlay();
        }
    }

    const flashBootButton = document.querySelector(".flash-boot-button");
    flashBootButton.addEventListener("click", () => handleFlash("boot"));

    const flashBootABButton = document.querySelector(".flash-boot-ab-button");
    flashBootABButton.addEventListener("click", () => handleFlash("boot_ab"));

    const flashBootAButton = document.querySelector(".flash-boot-a-button");
    flashBootAButton.addEventListener("click", () => handleFlash("boot_a"));

    const flashBootBButton = document.querySelector(".flash-boot-b-button");
    flashBootBButton.addEventListener("click", () => handleFlash("boot_b"));

    document.querySelector(".connect-button").addEventListener("click", connectDevice);
    document.querySelector(".command-form").addEventListener("submit", sendFormCommand);
    document.querySelector(".reboot-button").addEventListener("click", rebootDevice);
    document.querySelector(".reboot-bootloader-button").addEventListener("click", rebootToBootloader);
    document.querySelector(".reboot-recovery-button").addEventListener("click", rebootToRecovery);
    document.querySelector(".reboot-fastbootd-button").addEventListener("click", rebootToFastbootD);
    document.querySelector(".reboot-edl-button").addEventListener("click", rebootToEDL);
    document.querySelector(".boot-form").addEventListener("submit", bootFormFile);
    document.querySelector(".flash-form").addEventListener("submit", flashFormFile);
</script>
</body>
</html>
