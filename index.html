<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="dist/fastboot.mjs" type="module"></script>
    <script src="download.js" type="module"></script>
    <meta property="og:title" content="Fastboot Tool by ArKT" />
    <meta property="og:description" content="It can boot Images like recovery and can flash images in any partition" />
    <meta property="og:url" content="https://arkt-7.github.io/nabu/" />
    <meta property="og:type" content="website" />
    <meta name="description" content="It can boot Images like recovery and can flash images in any partition" />
    <meta name="title" content="Fastboot Tool for flashing/booting/rooting" />
    <title>Fastboot Tool by ArKT</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/android.png" type="image/png">
    <style>
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f0f0;
    color: #333;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative; /* Added */
}

h1 {
    color: #4a4a4a;
}

.container {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 20px;
    width: 100%;
    max-width: 600px;
    margin: 10px;
}

/*.button {
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    color: white;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    margin: 5px 0;
    width: 100%;
}*/

        .button {
		width: 100%;
		padding: 12px 20px;
		margin: 8px 0;
		border-radius: 12px;
		border: none;
		font-size: 18px;
		font-weight: bold;
		box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
		transition: all 0.3s ease;
		text-align: center; /* Center text horizontally */
		display: inline-block; /* Ensure centering works */
            background: linear-gradient(135deg, #0052cc, #3f87ff);
            color: #fff;
            cursor: pointer;
            animation: buttonGlow 2s ease-in-out infinite alternate;
			margin-top: 20px;
		}

.button:hover {
    background-color: #0056b3;
    transform: scale(1.02);
}

.button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

input[type="text"],
input[type="file"],
select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

label {
    font-weight: bold;
}

.progress-container {
    width: 100%;
    height: 20px;
    background-color: #f3f3f3;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
    display: none; /* Initially hidden */
}

.progress-bar {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: width 0.5s;
}

.status-field {
    font-weight: bold;
    margin-bottom: 10px;
}

pre.result-field {
    background-color: #f3f3f3;
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
    white-space: pre-wrap;
    max-height: 200px;
    border: 1px solid #ccc;
}

/* Styles for the progress overlay */
#progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: none; /* Hidden initially */
    justify-content: center;
    align-items: center;
    z-index: 1000; /* Bring it above everything */
}

#progress-overlay.active {
    display: flex;
}

#progress-message {
    color: white;
    font-size: 24px;
    text-align: center;
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}


.rboot-flash-form {
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.rboot-flash-form label {
    display: block;
    margin: 10px 0 5px;
}

.rboot-flash-form input,
.rboot-flash-form select {
    width: 100%;
    padding: 10px;
    margin: 5px 0 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.rboot-button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 5px;
}

.rboot-button:hover {
    background-color: #0056b3;
}

/* Progress Bar */
.rboot-progress-container {
    width: 100%;
    background-color: #f3f3f3;
    border-radius: 5px;
    margin: 20px 0;
    height: 30px;
    overflow: hidden;
}

.rboot-progress-bar {
    width: 0%;
    height: 100%;
    background-color: #4caf50;
    border-radius: 5px;
    transition: width 0.4s ease;
}

    </style>
</head>
<body>
    <h1>Fastboot Tool by ArKT</h1>

<!-- Add a progress overlay for the "Processing... Please wait" message -->
<div id="progress-overlay">
    <div id="progress-message">Processing... Please wait</div>
</div>

<div class="container">
    <p class="status-field">Not connected in Fastboot</p>
    <button class="button connect-button">Connect device Fastboot</button>
</div>

<hr />

<div class="container">
    <form class="command-form">
        <label for="command">Fastboot Command:</label>
        <input type="text" name="command" class="command-input" placeholder="Enter fastboot command here without 'fastboot' " />
        <input type="submit" value="Send" class="button" />
    </form>
    <button class="button reboot-button">Reboot Device</button>
    <button class="button reboot-bootloader-button">Reboot to Bootloader</button>
    <button class="button reboot-recovery-button">Reboot to Recovery</button>
    <button class="button reboot-fastbootd-button">Reboot to FastbootD</button>
    <button class="button reboot-edl-button">Reboot to EDL</button>
    <!-- Result field to display command outputs -->
<pre class="result-field" style="display: none;"></pre>

</div>

    <hr />


    <!-- New Container for Downloading and Flashing Images -->
    <div class="container">
    <form class="rboot-flash-form">
        <label for="rboot-flash-file">Flash Magisk rooted boot image:</label>
        <input type="file" name="rboot-flash-file" class="rboot-flash-file" accept=".img" />
        <br />
        
        <!-- New dropdown for partition selection -->
        <label for="rboot-flash-partition">Select Flash boot partition:</label>
        <select name="rboot-flash-partition" class="rboot-flash-partition" required>
            <option value="">Select boot partition</option>
            <option value="boot_ab" selected>Flash to Boot ab (both slots)</option>
            <option value="boot">Flash to Boot (current slot)</option>
            <option value="boot_a">Flash to Boot A only</option>
            <option value="boot_b">Flash to Boot B only</option>
        </select>
        <br />

        <!-- New dropdown for selecting predefined images -->
        <label for="rboot-flash-image">Magisk Rooted boot Images:</label>
        <select name="rboot-flash-image" class="rboot-flash-image">
            <option value="">Select rooted boot to flash</option>
            <option value="hyperos-miui-27000-nabu">Miui 14 to HyperOS(Magisk-27)</option>
            <option value="win-uefi-nabu">Windows UEFI Boot Nabu</option>
            <option value="twrp-mod-nabu">TWRP Modded Recovery Nabu</option>
            <option value="orangefox-mod-nabu">OrangeFox Modded Recovery Nabu</option>
        </select>
        
        <input type="submit" value="Flash" class="button" />
           <!-- Progress bar for feedback -->
    <div class="rboot-progress-container" style="display:none;">
        <div class="rboot-progress-bar" style="width:0%; background-color:#4caf50; height:20px;"></div>
    </div>
    </form>
</div>

<hr />

<div class="container">
    <form class="boot-form">
        <label for="boot-file">Boot image:</label>
        <input type="file" id="boot-file" name="boot-file" accept=".img" />
        <select name="boot-type" class="boot-type">
            <option value="">Select Images to boot on Nabu directly</option>
            <option value="twrp-nabu">Twrp Recovery Nabu</option>
            <option value="win-uefi-nabu">Windows UEFI Boot Nabu</option>
            <option value="twrp-mod-nabu">Twrp Modded Recovery Nabu</option>
            <option value="orangefox-mod-nabu">OrangeFox Modded Recovery Nabu</option>
        </select>
        <input type="submit" value="Boot" class="button" />
        <div class="progress-container" style="display: none;">
            <div class="progress-bar"></div>
        </div>
    </form>
</div>

<hr />

<div class="container">
    <form class="flash-form">
        <label for="flash-file">Flash image:</label>
        <input type="file" name="flash-file" class="flash-file" accept=".img" onchange="validateFile(this)" required />
        <br />
        <label for="flash-partition">Partition:</label>
        <input type="text" name="flash-partition" class="flash-partition" placeholder="Enter partition like- boot, dtbo, cust, recovery, etc." />
        <input type="submit" value="Flash" class="button" />
    </form>
</div>



    <hr />

   <script type="module">
    import * as fastboot from "./dist/fastboot.mjs";
    import { BlobStore } from "./download.js";

    let device = new fastboot.FastbootDevice();
    window.device = device;
    let blobStore = new BlobStore();

    fastboot.setDebugLevel(2);

    // Utility function to show the progress overlay and disable buttons
    function showProgressOverlay() {
        const progressOverlay = document.getElementById('progress-overlay');
        const buttons = document.querySelectorAll('.button');
        progressOverlay.classList.add('active');
        buttons.forEach(button => {
            button.disabled = true;
        });
    }

    // Utility function to hide the progress overlay and enable buttons
    function hideProgressOverlay() {
        const progressOverlay = document.getElementById('progress-overlay');
        const buttons = document.querySelectorAll('.button');
        progressOverlay.classList.remove('active');
        buttons.forEach(button => {
            button.disabled = false;
        });
    }
       

    // Validation function to allow only .img files
    function validateFile(inputElement) {
        const file = inputElement.files[0];
        const errorMessage = document.createElement('p');
        errorMessage.style.color = 'red';

        if (!file || !file.name.endsWith('.img')) {
            errorMessage.textContent = 'Please select a valid .img file.';
            inputElement.parentNode.appendChild(errorMessage);
            inputElement.value = ''; // Clear invalid file input
        } else {
            const existingError = inputElement.parentNode.querySelector('p');
            if (existingError) {
                existingError.remove(); // Remove error message if file is valid
            }
        }
    }

    function toggleElements(disable) {
        const formElements = document.querySelectorAll("input, button, select");
        formElements.forEach((element) => {
            if (!element.classList.contains('connect-button')) {
                element.disabled = disable;
            }
        });
    }

    async function connectDevice() {
        let statusField = document.querySelector(".status-field");
        statusField.textContent = "Connecting...";

        try {
            await device.connect();
        } catch (error) {
            statusField.textContent = `Failed to connect to device: ${error.message}`;
            toggleElements(true); // Enable all elements when connected
            return;
        }

        let product = await device.getVariable("product");
        let slot = await device.getVariable("current-slot");
        let serial = await device.getVariable("serialno");
        let bootloaderStatus = await device.getVariable("unlocked");

        let deviceName = "";
        if (product === "nabu") {
            deviceName = "Device name - Xiaomi Pad 5";
        } else if (product === "dm3q") {
            deviceName = "Device name - Samsung S23 Ultra";
        }

        let status = `Connected to - ${product} <br /> Current slot - ${slot} <br /> (serial: ${serial})`;
        if (deviceName) {
            status += `<br />${deviceName}`;
        }

        status += `<br />Bootloader status: ${bootloaderStatus ? 'Unlocked' : 'Locked'}`;
        statusField.innerHTML = status;

        toggleElements(false); // Enable all elements when connected
    }

    toggleElements(true); // Initially disable all features

    function handleDisconnect() {
        let statusField = document.querySelector(".status-field");
        statusField.textContent = "Not connected in Fastboot";
        toggleElements(true); // Disable all elements on disconnect
    }

       // Function to check if the device is still connected after operations
async function checkDeviceConnection() {
    let statusField = document.querySelector(".status-field");

    try {
        let product = await device.getVariable("product");
        if (product) {
            //statusField.textContent = "Device is still connected in Fastboot mode.";
        }
    } catch (error) {
        statusField.textContent = "Device disconnected!";
        toggleElements(true); // Disable all elements on disconnect
    }
}

    async function sendFormCommand(event) {
    event.preventDefault();
    let inputField = document.querySelector(".command-input");
    let command = inputField.value;
    if (!command.trim()) {
        alert("Please enter a command!");
        return;
    }

    let result = (await device.runCommand(command)).text;
    let resultField = document.querySelector(".result-field");
    resultField.textContent = result;
    resultField.style.display = 'block'; // Show the result field
    inputField.value = "";
        await checkDeviceConnection(); // Check if device is still connected after reboot
}


    async function rebootDevice() {
        await runRebootCommand("reboot", "Device rebooted successfully!");
    }

    async function rebootToBootloader() {
        await runRebootCommand("reboot-bootloader", "Rebooted to Bootloader successfully!");
    }

    async function rebootToRecovery() {
        await runRebootCommand("reboot-recovery", "Rebooted to Recovery successfully!");
    }

    async function rebootToFastbootD() {
        await runRebootCommand("reboot-fastboot", "Rebooted to FastbootD successfully!");
    }

    async function rebootToEDL() {
        await runRebootCommand("oem edl", "Rebooted to EDL successfully!");
    }

   //async function runRebootCommand(command, successMessage) {
       // let result = (await device.runCommand(command)).text;
       // document.querySelector(".result-field").textContent = result;
   // } 

       // After rebooting
async function runRebootCommand(command, successMessage) {
    try {
        let result = (await device.runCommand(command)).text;
        document.querySelector(".result-field").textContent = result;
        alert(successMessage);
    } catch (error) {
        alert(`Error during reboot: ${error.message}`);
    } finally {
        await checkDeviceConnection(); // Check if device is still connected after reboot
    }
}

    async function bootFormFile(event) {
        event.preventDefault();
        showProgressOverlay();
        let fileField = document.querySelector("#boot-file");
        let bootTypeSelect = document.querySelector(".boot-type");
        let selectedBootType = bootTypeSelect.value;

        let file;
        if (fileField.files.length > 0) {
            file = fileField.files[0];
        } else if (selectedBootType) {
            file = await downloadBootImage(getImagePath(selectedBootType));
        } else {
            alert("Please select a boot image file or choose a boot type!");
            hideProgressOverlay();
            return;
        }

        if (!file) {
            alert("Failed to obtain a valid boot image.");
            hideProgressOverlay();
            return;
        }

        try {
            await device.bootBlob(file);
            alert("Boot image booted successfully!");
        } catch (error) {
            console.error("Error booting image:", error);
            alert("Error booting image. Please try again.");
        } finally {
            fileField.value = ""; // Reset file input after use
            bootTypeSelect.selectedIndex = 0; // Reset selection
            hideProgressOverlay();
            await checkDeviceConnection(); // Check if device is still connected
        }
    }

    function getImagePath(selectedBootType) {
        switch (selectedBootType) {
            case "twrp-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/twrp-nabu.img";
            case "win-uefi-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/uefi-nabu.img";
            case "twrp-mod-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/twrp-modded-nabu.img";
            case "orangefox-mod-nabu":
                return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/orangefox-modded-nabu.img";
            default:
                return null;
        }
    }

    async function downloadBootImage(imagePath) {
        const progressBarContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        progressBarContainer.style.display = 'block'; // Show the progress bar

        try {
            const response = await fetch(imagePath);
            if (!response.ok) throw new Error("Failed to download boot image");

            const contentLength = response.headers.get('Content-Length');
            const total = parseInt(contentLength, 10);
            let loaded = 0;

            const reader = response.body.getReader();
            const chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                progressBar.style.width = `${(loaded / total) * 100}%`;
            }

            const blob = new Blob(chunks);
            return blob;
        } catch (error) {
            console.error("Download error:", error);
            alert("Error downloading boot image. Please try again.");
        } finally {
            progressBarContainer.style.display = 'none'; // Hide the progress bar
        }
    }

    async function flashFormFile(event) {
        event.preventDefault();
        showProgressOverlay();
        let fileField = document.querySelector(".flash-file");
        let partField = document.querySelector(".flash-partition");
        let file = fileField.files[0];

        if (!file) {
            alert("Please select a file to flash!");
            hideProgressOverlay();
            return;
        }

        if (!partField.value) {
            alert("Please specify a partition to flash!");
            hideProgressOverlay();
            return;
        }

        try {
            await device.flashBlob(partField.value, file);
            alert(`Successfully flashed ${partField.value}`);
        } catch (error) {
            alert(`Failed to flash: ${error.message}`);
        } finally {
            fileField.value = "";
            partField.value = "";
            hideProgressOverlay();
            await checkDeviceConnection(); // Check if device is still connected
        }
    }


       async function rbootFlashFormFile(event) {
    event.preventDefault();
    rbootShowProgressOverlay();
           showProgressOverlay();

    let fileField = document.querySelector(".rboot-flash-file");
    let partField = document.querySelector(".rboot-flash-partition");  // Updated to use dropdown
    let selectedImage = document.querySelector(".rboot-flash-image").value;

    let file;

    // Check if a file is uploaded or a predefined image is selected
    if (fileField.files.length > 0) {
        file = fileField.files[0];
    } else if (selectedImage) {
        file = await rbootDownloadFlashImage(rbootGetImagePath(selectedImage)); // Predefined image
    } else {
        alert("Please select a file to flash or choose a predefined image!");
        rbootHideProgressOverlay();
        hideProgressOverlay();
        return;
    }

    if (!file || !partField.value) {
        alert("Please select a valid file and partition!");
        rbootHideProgressOverlay();
        hideProgressOverlay();
        return;
    }

    try {
        await device.flashBlob(partField.value, file);
        alert(`Successfully flashed to ${partField.value}`);
    } catch (error) {
        alert(`Failed to flash: ${error.message}`);
    } finally {
        fileField.value = "";
        partField.value = "";
        rbootHideProgressOverlay();
        hideProgressOverlay();
        await CheckDeviceConnection(); // Check if device is still connected
    }
}


function rbootGetImagePath(selectedImage) {
    switch (selectedImage) {
        case "hyperos-miui-27000-nabu":
            return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/hyperos-miui-27000-nabu.img";
        case "win-uefi-nabu":
            return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/uefi-nabu.img";
        case "twrp-mod-nabu":
            return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/twrp-modded-nabu.img";
        case "orangefox-mod-nabu":
            return "https://media.githubusercontent.com/media/ArKT-7/nabu/main/bin/orangefox-modded-nabu.img";
        default:
            return null;
    }
}

async function rbootDownloadFlashImage(imagePath) {
    const progressBarContainer = document.querySelector('.rboot-progress-container');
    const progressBar = document.querySelector('.rboot-progress-bar');
    progressBarContainer.style.display = 'block';

    try {
        const response = await fetch(imagePath);
        if (!response.ok) throw new Error("Failed to download flash image");

        const contentLength = response.headers.get('Content-Length');
        const total = parseInt(contentLength, 10);
        let loaded = 0;

        const reader = response.body.getReader();
        const chunks = [];

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.length;
            progressBar.style.width = `${(loaded / total) * 100}%`;
        }

        const blob = new Blob(chunks);
        return blob;
    } catch (error) {
        console.error("Download error:", error);
        alert("Error downloading flash image. Please try again.");
    } finally {
        progressBarContainer.style.display = 'none';
    }
}

function rbootShowProgressOverlay() {
    const progressBarContainer = document.querySelector('.rboot-progress-container');
    const progressBar = document.querySelector('.rboot-progress-bar');
    progressBarContainer.style.display = 'block';
    progressBar.style.width = '0%'; // Reset progress bar
}

function rbootHideProgressOverlay() {
    const progressBarContainer = document.querySelector('.rboot-progress-container');
    progressBarContainer.style.display = 'none';
}


    document.querySelector(".connect-button").addEventListener("click", connectDevice);
    document.querySelector(".command-form").addEventListener("submit", sendFormCommand);
    document.querySelector(".reboot-button").addEventListener("click", rebootDevice);
    document.querySelector(".reboot-bootloader-button").addEventListener("click", rebootToBootloader);
    document.querySelector(".reboot-recovery-button").addEventListener("click", rebootToRecovery);
    document.querySelector(".reboot-fastbootd-button").addEventListener("click", rebootToFastbootD);
    document.querySelector(".reboot-edl-button").addEventListener("click", rebootToEDL);
    document.querySelector(".boot-form").addEventListener("submit", bootFormFile);
    document.querySelector(".flash-form").addEventListener("submit", flashFormFile);
    document.querySelector(".rboot-flash-form").addEventListener("submit", rbootFlashFormFile);
</script>
</body>
</html>
